// --- PREMIUM ACTIVATION LOGIC ---
function activatePremium() {
    const now = Date.now();
    const lockedUntil = parseInt(localStorage.getItem('premiumLockedUntil') || '0', 10);
    if (lockedUntil && now < lockedUntil) {
        alert('Premium is locked. You can reactivate premium after the lock period ends.');
        return;
    }
    localStorage.setItem('premiumActive', 'true');
    localStorage.setItem('premiumActivatedAt', now.toString());
    // Set lockedUntil to 12 hours from now (6h active, 6h lock)
    localStorage.setItem('premiumLockedUntil', (now + 12 * 60 * 60 * 1000).toString());
    showPremiumActivationWarning();
    updateFeatureGatingUI();
}

function checkPremiumStatus() {
    const premiumActive = localStorage.getItem('premiumActive') === 'true';
    const activatedAt = parseInt(localStorage.getItem('premiumActivatedAt') || '0', 10);
    const lockedUntil = parseInt(localStorage.getItem('premiumLockedUntil') || '0', 10);
    const now = Date.now();
    if (premiumActive && activatedAt > 0) {
        if (now - activatedAt >= 6 * 60 * 60 * 1000) {
            // 6 hours passed, lock premium
            localStorage.setItem('premiumActive', 'false');
            updateFeatureGatingUI();
            return false;
        }
        return true;
    }
    if (lockedUntil > 0 && now < lockedUntil) {
        // Still locked, cannot reactivate
        return false;
    }
    // If lockedUntil has passed, allow reactivation
    return false;
}

function canActivatePremium() {
    const lockedUntil = parseInt(localStorage.getItem('premiumLockedUntil') || '0', 10);
    const now = Date.now();
    // Only allow activation if lockedUntil is not set or has passed
    return (!lockedUntil || now >= lockedUntil);
}

function showPremiumActivationWarning() {
    alert('Premium is now unlocked for 6 hours. After 6 hours, premium will be locked automatically. You can reactivate premium after another 6 hours.');
}

// Call this on every page load to enforce premium lockout
document.addEventListener('DOMContentLoaded', function() {
    checkPremiumStatus();
    updateFeatureGatingUI();
});
// Ensure Exit button shows the exit modal
function confirmEndInterview() {
    var modal = document.getElementById('exit-modal');
    if (modal) {
        modal.style.opacity = '1';
        modal.style.pointerEvents = 'auto';
    }
}
<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intro.js/minified/introjs.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/intro.js/minified/intro.min.js"></script>
    <script src="ai_interview_room_tour.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google-adsense-account" content="ca-pub-6098180211265684">
    <title>AI Interview Room - AI Interview Simulator</title>
    <link rel="stylesheet" href="../css/main.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        .avatar-container {
            background: linear-gradient(135deg, #1E40AF 0%, #1E3A8A 100%);
            position: relative;
            overflow: hidden;
        }
        
        .avatar-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .webcam-feed {
            border: 2px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .transcription-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .feedback-hint {
            animation: slideInFromRight 0.5s ease-out;
        }
        
        @keyframes slideInFromRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .voice-wave {
            animation: voiceWave 1.5s ease-in-out infinite;
        }
        
        @keyframes voiceWave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(1.5); }
        }
        
        .processing-loader {
            background: linear-gradient(90deg, #3B82F6, #10B981, #3B82F6);
            background-size: 200% 100%;
            animation: shimmer 2s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .avatar-speaking {
            animation: avatarPulse 2s ease-in-out infinite;
        }
        
        @keyframes avatarPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
    </style>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6098180211265684" crossorigin="anonymous"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6098180211265684" crossorigin="anonymous"></script>
<script type="module" src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Faiintervi7306back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.6"></script>
<!-- Include Chatbot CSS and JS -->
<link rel="stylesheet" href="../css/chatbot.css" />
<script src="../public/chatbot.js" defer></script>
</head>
<body class="min-h-screen bg-secondary-900 flex items-center justify-center min-h-screen" style="overflow:hidden;">
    <!-- Main Interview Container -->
    <div class="w-full h-full flex flex-col items-center justify-center relative" style="min-height: 100vh; height: 100vh; overflow: hidden;">
        <!-- Header Controls -->
        <div class="flex items-center justify-between p-4 bg-secondary-800 border-b border-secondary-700 z-20">
            <!-- Progress Info -->
            <div class="flex items-center space-x-4">
                <button onclick="confirmEndInterview()" class="flex items-center space-x-2 px-3 py-2 bg-secondary-700 hover:bg-secondary-600 rounded-lg transition-colors">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    <span class="text-white text-sm font-medium hidden sm:inline">Exit</span>
                </button>
                
                <div class="flex items-center space-x-3">
                    <div class="glass rounded-lg px-3 py-1">
                        <span id="question-counter" class="text-white text-sm font-medium">Question 1/15</span>
                    </div>
                    <div class="glass rounded-lg px-3 py-1">
                        <span id="difficulty-indicator" class="text-accent-100 text-sm font-medium">Basic</span>
                    </div>
                </div>
            </div>
            
            <!-- Timer and Status -->
            <div class="flex items-center space-x-3">
                <div id="timer-display" class="glass rounded-lg px-3 py-1">
                    <span class="text-white text-sm font-medium">25:00</span>
                </div>
                <div id="connection-status" class="flex items-center space-x-2">
                    <div class="w-2 h-2 bg-accent-500 rounded-full animate-pulse"></div>
                    <span class="text-accent-100 text-sm font-medium hidden sm:inline">Connected</span>
                </div>
            </div>
        </div>
        
        <!-- Main Interview Area (centered) -->
        <div class="flex flex-col items-center justify-center w-full h-full relative" style="min-height: 80vh;">
            <!-- AI Avatar Centered -->
            <div id="avatar-placeholder" class="flex flex-col items-center justify-center mb-4">
                <div class="w-36 h-36 md:w-48 md:h-48 mx-auto mb-2 relative">
                    <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="AI Interviewer" class="w-full h-full object-cover rounded-full border-4 border-white shadow-2xl avatar-speaking" onerror="this.src='https://images.pexels.com/photos/2379004/pexels-photo-2379004.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2'; this.onerror=null;" />
                    <div class="absolute -bottom-2 -right-2 w-8 h-8 bg-accent-500 rounded-full flex items-center justify-center">
                        <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>
                <h3 class="text-white text-xl font-semibold mb-1">Sarah Chen</h3>
                <p class="text-blue-100 text-sm">Senior HR Manager</p>
            </div>
            <!-- Current Question Display Centered -->
            <div id="current-question" class="w-full max-w-2xl mx-auto mb-4">
                <div class="glass rounded-2xl p-4 md:p-6">
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-primary-500 rounded-full flex items-center justify-center flex-shrink-0">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <p id="question-text" class="text-white text-base md:text-lg font-medium leading-relaxed"></p>
                            <div class="flex items-center justify-end mt-3">
                                <button id="repeat-question-btn" class="text-blue-100 hover:text-white text-sm font-medium transition-colors">
                                    ðŸ”„ Repeat
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Voice Controls Centered -->
            <div class="flex items-center justify-center space-x-4 mt-2 mb-2">
                <button id="start-recording-btn" class="flex items-center space-x-2 px-6 py-3 bg-accent-600 hover:bg-accent-700 rounded-xl transition-colors touch-target">
                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"/>
                    </svg>
                    <span class="text-white font-medium">Start Answer</span>
                </button>
                <button id="stop-recording-btn" class="flex items-center space-x-2 px-6 py-3 bg-error hover:bg-red-700 rounded-xl transition-colors touch-target opacity-50" disabled>
                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"/>
                    </svg>
                    <span class="text-white font-medium">Stop Answer</span>
                </button>
                <button id="next-question-btn" class="flex items-center space-x-2 px-4 py-3 bg-secondary-700 hover:bg-secondary-600 rounded-xl transition-colors touch-target">
                    <span class="text-white font-medium">Next</span>
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
            <!-- Real-time Transcription Centered -->
            <div id="transcription-container" class="transcription-panel rounded-xl p-4 max-h-32 overflow-y-auto w-full max-w-2xl mx-auto mt-2">
                <div class="flex items-center justify-between mb-2">
                    <h4 class="text-secondary-700 text-sm font-semibold">Your Response</h4>
                    <div class="flex items-center space-x-2">
                        <div id="speech-accuracy" class="flex items-center space-x-1">
                            <div class="w-2 h-2 bg-accent-500 rounded-full"></div>
                            <span class="text-secondary-600 text-xs">95% Accuracy</span>
                        </div>
                        <button id="clear-transcription" class="text-secondary-500 hover:text-secondary-700 text-xs">Clear</button>
                    </div>
                </div>
                <div id="transcription-text" class="text-secondary-800 text-sm leading-relaxed min-h-[60px]">
                    <span class="text-secondary-400 italic">Your speech will appear here in real-time...</span>
                </div>
                <!-- Voice Wave Indicator -->
                <div id="voice-indicator" class="flex items-center justify-center space-x-1 mt-3 opacity-0">
                    <div class="voice-wave w-1 h-4 bg-accent-500 rounded-full"></div>
                    <div class="voice-wave w-1 h-6 bg-accent-500 rounded-full" style="animation-delay: 0.1s"></div>
                    <div class="voice-wave w-1 h-8 bg-accent-500 rounded-full" style="animation-delay: 0.2s"></div>
                    <div class="voice-wave w-1 h-6 bg-accent-500 rounded-full" style="animation-delay: 0.3s"></div>
                    <div class="voice-wave w-1 h-4 bg-accent-500 rounded-full" style="animation-delay: 0.4s"></div>
                </div>
            </div>
        </div>
            
            <!-- User Webcam Feed -->
            <div id="webcam-container" class="absolute top-4 right-4 w-32 h-24 md:w-40 md:h-30 webcam-feed rounded-lg overflow-hidden bg-secondary-800">
                <video id="user-webcam" class="w-full h-full object-cover" autoplay muted playsinline></video>
                <div id="webcam-placeholder" class="absolute inset-0 flex items-center justify-center bg-secondary-700">
                    <svg class="w-8 h-8 text-secondary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                </div>
                <!-- Emotion Detection Overlay -->
                <div id="emotion-overlay" class="absolute top-1 left-1 glass rounded px-2 py-1 opacity-0">
                    <span id="detected-emotion" class="text-white text-xs font-medium">ðŸ˜Š Confident</span>
                </div>
            </div>
            
            <!-- Live Feedback Hints -->
            <div id="feedback-hints" class="absolute top-1/2 right-4 transform -translate-y-1/2 space-y-2">
                <!-- Feedback hints will be dynamically added here -->
            </div>
            
            <!-- Current Question Display (removed duplicate/overlapping block) -->
        </div>
        
    </div>
    
    <!-- Premium Features Overlay -->
    <div id="premium-features" class="absolute top-20 left-4 space-y-2 opacity-0">
        <div class="glass rounded-lg p-3">
            <div class="flex items-center space-x-2">
                <svg class="w-4 h-4 text-accent-100" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                <span class="text-white text-xs font-medium">Performance: 87%</span>
            </div>
        </div>
        <div class="glass rounded-lg p-3">
            <div class="flex items-center space-x-2">
                <svg class="w-4 h-4 text-accent-100" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                </svg>
                <span class="text-white text-xs font-medium">Bookmarked</span>
            </div>
        </div>
    </div>
    
    <!-- Exit Confirmation Modal -->
    <div id="exit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity">
        <div class="glass rounded-2xl p-6 max-w-sm mx-4">
            <div class="text-center">
                <div class="w-16 h-16 bg-warning text-white rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                    </svg>
                </div>
                <h3 class="text-white text-lg font-semibold mb-2">End Interview?</h3>
                <p class="text-blue-100 text-sm mb-6">Your progress will be saved, but you won't be able to continue this session.</p>
                <div class="flex space-x-3">
                    <button onclick="closeExitModal()" class="flex-1 px-4 py-2 bg-secondary-600 hover:bg-secondary-500 text-white rounded-lg transition-colors">
                        Continue
                    </button>
                    <button onclick="endInterview()" class="flex-1 px-4 py-2 bg-error hover:bg-red-700 text-white rounded-lg transition-colors">
                        End Interview
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chatbot HTML -->
    <div id="chatbot-container">
        <button id="chatbot-toggle">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2v-8a2 2 0 012-2h2m10-4H7a2 2 0 00-2 2v0a2 2 0 002 2h10a2 2 0 002-2v0a2 2 0 00-2-2z" />
            </svg>
        </button>
        <div id="chatbot-window">
            <div class="header">
                <h3>Chat with Us!</h3>
                <button id="chatbot-close">&times;</button>
            </div>
            <div class="messages" id="chatbot-messages">
                <div>Hi! How can I assist you today?</div>
            </div>
            <div class="input">
                <input id="chatbot-input" type="text" placeholder="Type your message..." />
            </div>
        </div>
    </div>
    
    <script>
    // --- BEGIN: Robust Interview Room Core Fixes ---
    // Global variables
    let currentQuestion = 1;
    let totalQuestions = 15;
    let isRecording = false;
    let recognition;
    let synthesis = window.speechSynthesis;
    let interviewTimer;
    let thinkingTimer;
    let webcamStream;
    let faceApiLoaded = false;
    let resumeData = null;
    let interviewSetup = null;
    let currentTranscript = '';
    let answerStartTime = null;
    let isListening = false;
    let webcamPermissionDenied = false;

    // Load setup and resume data
    try {
        resumeData = JSON.parse(localStorage.getItem('resumeData') || '{}');
        interviewSetup = JSON.parse(localStorage.getItem('interviewSetup') || '{}');
    } catch (e) {
        console.error('Failed to load setup data:', e);
    }

    // Feature gating logic for basic vs premium
    const setupData = JSON.parse(localStorage.getItem('interviewSetup') || '{}');
    const premiumActive = localStorage.getItem('premiumActive') === 'true';
    const level = (setupData.level || setupData.planType || 'basic').toLowerCase();

    // --- Core Interview Room Functions ---
    function speakText(text) {
        if (!window.speechSynthesis) return;
        try {
            window.speechSynthesis.cancel();
            const utter = new window.SpeechSynthesisUtterance(text);
            utter.lang = 'en-US';
            utter.rate = 1;
            utter.pitch = 1;
            utter.volume = 1;
            window.speechSynthesis.speak(utter);
        } catch (e) { console.error('Speech synthesis error:', e); }
    }

    function speakQuestion() {
        const q = document.getElementById('question-text');
        if (q && q.textContent && q.textContent.trim().length > 0) speakText(q.textContent);
    }

    function loadCurrentQuestion() {
        const q = interviewQuestions[currentQuestion - 1];
        document.getElementById('question-counter').textContent = `Question ${currentQuestion}/${interviewQuestions.length}`;
        document.getElementById('question-text').textContent = q ? q.text : '';
        clearTranscription();
        setTimeout(() => speakQuestion(), 500);
    }

    function startInterviewTimer() {
        // Set timer based on plan: 15 min for basic, 35 min for premium
        let duration;
        const level = (interviewSetup.level || 'basic').toLowerCase();
        if (level === 'basic') {
            duration = 15 * 60;
        } else {
            duration = 35 * 60;
        }
        const timerDisplay = document.getElementById('timer-display').querySelector('span');
        if (interviewTimer) clearInterval(interviewTimer);
        function updateTimer() {
            const min = Math.floor(duration / 60).toString().padStart(2, '0');
            const sec = (duration % 60).toString().padStart(2, '0');
            timerDisplay.textContent = `${min}:${sec}`;
            if (duration > 0) {
                duration--;
            } else {
                clearInterval(interviewTimer);
                completeInterview();
            }
        }
        updateTimer();
        interviewTimer = setInterval(updateTimer, 1000);
    }

    function startThinkingTimer() {
        let duration = 2 * 60; // 2 minutes
        if (thinkingTimer) clearInterval(thinkingTimer);
        function updateThinking() {
            if (duration > 0) duration--;
            else clearInterval(thinkingTimer);
        }
        thinkingTimer = setInterval(updateThinking, 1000);
    }

    function clearTranscription() {
        document.getElementById('transcription-text').innerHTML = '<span class="text-secondary-400 italic">Your speech will appear here in real-time...</span>';
        currentTranscript = '';
    }
    // --- END: Robust Interview Room Core Fixes ---

    function showPremiumFeatures() {
        const pf = document.getElementById('premium-features');
        if (pf) pf.style.opacity = 1;
        // Unlock advanced feedback, analysis, etc.
        document.body.classList.add('premium-active');
    }
    function hidePremiumFeatures() {
        const pf = document.getElementById('premium-features');
        if (pf) pf.style.opacity = 0;
        document.body.classList.remove('premium-active');
    }

    function updateFeatureGatingUI() {
        if (level === 'premium' && premiumActive) {
            showPremiumFeatures();
            document.getElementById('difficulty-indicator').textContent = 'Premium';
        } else {
            hidePremiumFeatures();
            document.getElementById('difficulty-indicator').textContent = 'Basic';
            // Optionally lock advanced feedback UI
            const advFeedback = document.querySelectorAll('.advanced-feedback');
            advFeedback.forEach(el => el.classList.add('opacity-50', 'pointer-events-none'));
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        updateFeatureGatingUI();
        // --- PHASE 1: Randomized Greeting ---
        const candidateName = (interviewSetup && interviewSetup.candidateName) || 'Candidate';
        const greetings = [
            `Hello ${candidateName}, welcome. Please take a seat. Howâ€™s your day going?`,
            `Good ${getTimeOfDay()}, ${candidateName}. I see youâ€™ve arrived right on time â€” punctuality is a good sign.`,
            `Hi ${candidateName}, nice to meet you. I hope you didnâ€™t face any trouble finding us today.`
        ];
        function getTimeOfDay() {
            const h = new Date().getHours();
            if (h < 12) return 'morning';
            if (h < 18) return 'afternoon';
            return 'evening';
        }
        // --- PHASE 2: Dress Impression ---
        function askDressImpression() {
            // Ask user about their dress
            document.getElementById('question-text').textContent = 'Before we begin, could you briefly describe what you are wearing today? (e.g., formal, casual, etc.)';
            speakText('Before we begin, could you briefly describe what you are wearing today? For example, formal, casual, or something else.');
            // Listen for answer
            startDressAnswerCapture();
        }
        function startDressAnswerCapture() {
            // Temporarily override recording logic for dress answer
            const startBtn = document.getElementById('start-recording-btn');
            const stopBtn = document.getElementById('stop-recording-btn');
            let dressAnswer = '';
            function onDressStart() {
                if (!recognition) return;
                recognition.onresult = (event) => {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            dressAnswer += event.results[i][0].transcript;
                        }
                    }
                    document.getElementById('transcription-text').textContent = transcript;
                };
                recognition.onend = () => {
                    // Analyze dress answer
                    let response = dressAnswer.toLowerCase();
                    let comment = '';
                    if (response.includes('formal') || response.includes('suit') || response.includes('shirt') || response.includes('professional')) {
                        comment = 'Youâ€™ve dressed professionally â€” always a good start for an interview.';
                    } else if (response.includes('casual') || response.includes('t-shirt') || response.includes('jeans')) {
                        comment = 'I see youâ€™ve gone with a casual look today â€” is that your usual work style?';
                    } else if (response.trim().length > 0) {
                        comment = 'Interesting choice of outfit. Do you think first impressions matter in professional settings?';
                    } else {
                        comment = 'Thank you. Letâ€™s proceed.';
                    }
                    document.getElementById('question-text').textContent = comment;
                    speakText(comment);
                    setTimeout(() => {
                        startMainInterviewPhases();
                    }, 2500);
                };
                recognition.start();
            }
            startBtn.onclick = onDressStart;
            stopBtn.onclick = function() {
                if (recognition) recognition.stop();
            };
        }
        // --- PHASE 3+ (Main Interview) ---
        function startMainInterviewPhases() {
            // Restore normal event listeners and load questions
            window.interviewQuestions = generatePersonalizedQuestions();
            window.totalQuestions = interviewQuestions.length;
            window.feedbackHints = [
                { text: "ðŸ˜Š Great! Maintain that confident tone", type: "positive" },
                { text: "ðŸ‘ï¸ Maintain eye contact with the camera", type: "neutral" },
                { text: "ðŸ“¢ Speak a bit louder and clearer", type: "improvement" },
                { text: "â±ï¸ Take your time to think before answering", type: "neutral" },
                { text: "ðŸ’ª Show more confidence in your abilities", type: "positive" },
                { text: "ðŸ“‹ Consider mentioning specific examples", type: "improvement" },
                { text: "ðŸŽ¯ Stay focused on the question asked", type: "neutral" },
                { text: "âœ¨ Excellent! That's a strong response", type: "positive" }
            ];
            initializeWebcam();
            initializeEnhancedSpeechRecognition();
            initializeFaceAPI();
            startInterviewTimer();
            // --- PHASE 3: Resume Acknowledgement ---
            let resumeComment = '';
            if (resumeData && resumeData.skills && resumeData.skills.length) {
                resumeComment = `I see from your resume youâ€™ve worked with ${resumeData.skills.slice(0, 2).join(' and ')}. Could you walk me through your role in that?`;
            } else if (resumeData && resumeData.projects && resumeData.projects.length) {
                resumeComment = `I see from your resume youâ€™ve worked on ${resumeData.projects[0]}. Could you walk me through your role in that?`;
            } else if (resumeData && resumeData.gaps) {
                resumeComment = `I noticed thereâ€™s a gap between ${resumeData.gaps}. Can you tell me about that period?`;
            } else {
                resumeComment = 'Letâ€™s start by talking about your background. Could you share a bit about your experience?';
            }
            document.getElementById('question-text').textContent = resumeComment;
            speakText(resumeComment);
            // Wait for answer, then ask warm-up
            let phase = 3;
            let warmupAsked = false;
            let closingTriggered = false;
            let timerInterval = setInterval(() => {
                // --- PHASE 7: Smooth Closing at 1:30 left ---
                const timerDisplay = document.getElementById('timer-display').querySelector('span');
                if (timerDisplay && !closingTriggered) {
                    const [min, sec] = timerDisplay.textContent.split(':').map(Number);
                    if ((min === 1 && sec <= 30) || (min === 0 && sec < 90)) {
                        closingTriggered = true;
                        const closingMsg = `Thank you for your responses so far. Weâ€™ve covered a lot. Letâ€™s proceed to a scenario-based question next.`;
                        document.getElementById('question-text').textContent = closingMsg;
                        speakText(closingMsg);
                        setTimeout(() => {
                            // End interview and show results
                            endInterview();
                        }, 6000);
                    }
                }
            }, 1000);
            // Override recording logic for first two phases
            const startBtn = document.getElementById('start-recording-btn');
            const stopBtn = document.getElementById('stop-recording-btn');
            let answer = '';
            function onPhase3Start() {
                if (!recognition) return;
                recognition.onresult = (event) => {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            answer += event.results[i][0].transcript;
                        }
                    }
                    document.getElementById('transcription-text').textContent = transcript;
                };
                recognition.onend = () => {
                    // --- PHASE 4: Warm-Up ---
                    if (!warmupAsked) {
                        warmupAsked = true;
                        const warmups = [
                            "What inspired you to apply for this position?",
                            "How would you describe yourself in one sentence?",
                            "If you could work on any project here, what would it be?"
                        ];
                        const warmupQ = warmups[Math.floor(Math.random() * warmups.length)];
                        document.getElementById('question-text').textContent = warmupQ;
                        speakText(warmupQ);
                        answer = '';
                        startBtn.onclick = onWarmupStart;
                        stopBtn.onclick = function() { if (recognition) recognition.stop(); };
                    }
                };
                recognition.start();
            }
            function onWarmupStart() {
                if (!recognition) return;
                recognition.onresult = (event) => {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            answer += event.results[i][0].transcript;
                        }
                    }
                    document.getElementById('transcription-text').textContent = transcript;
                };
                recognition.onend = () => {
                    // Proceed to main questions
                    clearInterval(timerInterval);
                    restoreMainInterviewListeners();
                    loadCurrentQuestion();
                    setTimeout(() => speakQuestion(), 1200);
                };
                recognition.start();
            }
            startBtn.onclick = onPhase3Start;
            stopBtn.onclick = function() { if (recognition) recognition.stop(); };
            // --- Adaptive Follow-Up (Phase 6) ---
            function restoreMainInterviewListeners() {
                function adaptiveFollowUp(transcript) {
                    if (!transcript) return;
                    const vagueWords = ['maybe', 'not sure', 'sometimes', 'I guess', 'I think'];
                    const impressiveWords = ['led', 'achieved', 'success', 'improved', 'innovated', 'solved', 'managed'];
                    let followup = '';
                    if (vagueWords.some(w => transcript.toLowerCase().includes(w))) {
                        followup = 'Could you give me a specific example?';
                    } else if (impressiveWords.some(w => transcript.toLowerCase().includes(w))) {
                        followup = 'Thatâ€™s a strong approach. How did you measure success?';
                    }
                    if (followup) {
                        setTimeout(() => {
                            document.getElementById('question-text').textContent = followup;
                            speakText(followup);
                        }, 1000);
                    }
                }
                // Patch stopRecording to add adaptive follow-up
                const origStop = stopRecording;
                window.stopRecording = function() {
                    if (!recognition || !isRecording) return;
                    isRecording = false;
                    try { recognition.stop(); } catch (error) { console.error('Failed to stop recognition:', error); }
                    document.getElementById('start-recording-btn').disabled = false;
                    document.getElementById('start-recording-btn').classList.remove('opacity-50');
                    document.getElementById('stop-recording-btn').disabled = true;
                    document.getElementById('stop-recording-btn').classList.add('opacity-50');
                    document.getElementById('start-recording-btn').innerHTML = `
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"/>
                        </svg>
                        <span class="text-white font-medium">Start Answer</span>
                    `;
                    clearInterval(thinkingTimer);
                    if (currentTranscript.trim().length > 0) {
                        analyzeCompleteAnswer(currentTranscript);
                        showAIProcessing();
                        setTimeout(() => {
                            hideAIProcessing();
                            provideIntelligentFeedback();
                            adaptiveFollowUp(currentTranscript);
                            setTimeout(() => {
                                nextQuestion();
                            }, 1800);
                        }, 3000);
                    } else {
                        showFeedbackHint("ðŸŽ¤ No answer recorded. Please try again.", "improvement");
                    }
                    if (synthesis && synthesis.speaking) { synthesis.cancel(); }
                };
            }
        }
        // --- Personalized Questions Generator (moved from above) ---
        function generatePersonalizedQuestions() {
            const questions = [];
            const level = (interviewSetup.level || 'basic').toLowerCase();
            if (resumeData) {
                if (resumeData.skills && resumeData.skills.length) {
                    questions.push({
                        text: `I see from your resume youâ€™ve worked with ${resumeData.skills.slice(0, 2).join(' and ')}. Could you walk me through your role in that?`,
                        category: "Resume"
                    });
                    questions.push({
                        text: `Your background in ${resumeData.skills[0]} stands out â€” how did you get into it?`,
                        category: "Resume"
                    });
                }
                if (resumeData.projects && resumeData.projects.length) {
                    questions.push({
                        text: `I see from your resume youâ€™ve worked on ${resumeData.projects[0]}. Could you walk me through your role in that?`,
                        category: "Resume"
                    });
                }
                if (resumeData.gaps) {
                    questions.push({
                        text: `I noticed thereâ€™s a gap between ${resumeData.gaps}. Can you tell me about that period?`,
                        category: "Resume"
                    });
                }
            }
            // Warm-up questions
            questions.push({ text: "What inspired you to apply for this position?", category: "Warmup" });
            questions.push({ text: "How would you describe yourself in one sentence?", category: "Warmup" });
            questions.push({ text: "If you could work on any project here, what would it be?", category: "Warmup" });
            // HR and role-specific
            questions.push({ text: "Tell me about yourself.", category: "HR" });
            questions.push({ text: "Why should we hire you for this role?", category: "HR" });
            questions.push({ text: "Where do you see yourself in 5 years?", category: "HR" });
            questions.push({ text: "Whatâ€™s your biggest professional strength and weakness?", category: "HR" });
            if (interviewSetup.jobRole && interviewSetup.jobRole.toLowerCase().includes('developer')) {
                questions.push({ text: "How do you ensure your code is maintainable?", category: "Role" });
                questions.push({ text: "Explain the difference between REST and GraphQL.", category: "Role" });
            }
            if (interviewSetup.jobRole && interviewSetup.jobRole.toLowerCase().includes('marketing')) {
                questions.push({ text: "Whatâ€™s your process for launching a new campaign?", category: "Role" });
                questions.push({ text: "Tell me about a time you handled negative PR.", category: "Role" });
            }
            if (interviewSetup.jobRole && interviewSetup.jobRole.toLowerCase().includes('accountant')) {
                questions.push({ text: "How do you ensure compliance with regulations?", category: "Role" });
                questions.push({ text: "Explain the process of preparing a balance sheet.", category: "Role" });
            }
            // Adaptive follow-up and closing
            questions.push({ text: "Could you give me a specific example?", category: "Followup" });
            questions.push({ text: "Thatâ€™s a strong approach. How did you measure success?", category: "Followup" });
            questions.push({ text: "Thank you for your responses so far, ${candidateName}. Weâ€™ve covered a lot. Letâ€™s proceed to a scenario-based question next.", category: "Closing" });
            // Fill up to 50 questions
            let maxQuestions = 50;
            let baseCount = questions.length;
            for (let i = 0; i < maxQuestions - baseCount; i++) {
                questions.push({ text: `Q${questions.length + 1}: Tell us more about your experience.`, category: level === 'premium' ? "Premium" : "General" });
            }
            return questions;
        }
        // --- Start Interview Flow ---
        // Greet, then ask about dress, then main interview
        const greeting = greetings[Math.floor(Math.random() * greetings.length)];
        document.getElementById('question-text').textContent = greeting;
        speakText(greeting);
        setTimeout(() => {
            askDressImpression();
        }, 3500);
    });
    
    function showPersonalizedWelcome() {
        const jobRole = interviewSetup.jobRole || 'this position';
        const welcomeMessage = `Welcome! I've analyzed your resume and prepared ${totalQuestions} personalized questions for the ${jobRole} role. Let's begin your interview.`;
        
        setTimeout(() => {
            speakText(welcomeMessage);
            showFeedbackHint("ðŸŽ¯ Questions tailored to your resume", "positive");
        }, 1000);
    }
    
    function setupEventListeners() {
        // Remove previous listeners to avoid duplicates
        const startBtn = document.getElementById('start-recording-btn');
        const stopBtn = document.getElementById('stop-recording-btn');
        const nextBtn = document.getElementById('next-question-btn');
        const repeatBtn = document.getElementById('repeat-question-btn');
        const clearBtn = document.getElementById('clear-transcription');
        // Remove all listeners by cloning
        if (startBtn) startBtn.replaceWith(startBtn.cloneNode(true));
        if (stopBtn) stopBtn.replaceWith(stopBtn.cloneNode(true));
        if (nextBtn) nextBtn.replaceWith(nextBtn.cloneNode(true));
        if (repeatBtn) repeatBtn.replaceWith(repeatBtn.cloneNode(true));
        if (clearBtn) clearBtn.replaceWith(clearBtn.cloneNode(true));
        // Re-select after cloning
        const startBtn2 = document.getElementById('start-recording-btn');
        const stopBtn2 = document.getElementById('stop-recording-btn');
        const nextBtn2 = document.getElementById('next-question-btn');
        const repeatBtn2 = document.getElementById('repeat-question-btn');
        const clearBtn2 = document.getElementById('clear-transcription');
        if (startBtn2) startBtn2.addEventListener('click', startRecording);
        if (stopBtn2) stopBtn2.addEventListener('click', stopRecording);
        if (nextBtn2) nextBtn2.addEventListener('click', nextQuestion);
        if (repeatBtn2) repeatBtn2.addEventListener('click', repeatQuestion);
        if (clearBtn2) clearBtn2.addEventListener('click', clearTranscription);
        // Remove previous keyboard shortcut listeners
        document.removeEventListener('keydown', handleKeyboardShortcuts, true);
        document.addEventListener('keydown', handleKeyboardShortcuts, true);
    }
    
    function handleKeyboardShortcuts(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'r':
                    e.preventDefault();
                    repeatQuestion();
                    break;
                case 'n':
                    e.preventDefault();
                    nextQuestion();
                    break;
                case ' ':
                    e.preventDefault();
                    if (isRecording) {
                        stopRecording();
                    } else {
                        startRecording();
                    }
                    break;
            }
        }
    }
    
    async function requestWebcamPermission() {
        const webcamContainer = document.getElementById('webcam-container');
        const placeholder = document.getElementById('webcam-placeholder');
        
        // Show permission request UI
        placeholder.innerHTML = `
            <div class="text-center p-2">
                <div class="animate-pulse mb-2">
                    <svg class="w-8 h-8 text-blue-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                </div>
                <p class="text-blue-300 text-xs">Requesting camera access...</p>
            </div>
        `;
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: { ideal: 640 }, 
                    height: { ideal: 480 }, 
                    facingMode: 'user',
                    frameRate: { ideal: 30 }
                }, 
                audio: false 
            });
            
            return stream;
        } catch (error) {
            console.error('Camera permission error:', error);
            throw error;
        }
    }
    
    function showCameraPermissionDenied() {
        const placeholder = document.getElementById('webcam-placeholder');
        const webcamContainer = document.getElementById('webcam-container');
        
        // Add a subtle red border to indicate the issue
        webcamContainer.classList.add('border-red-400');
        webcamContainer.classList.remove('border-blue-400');
        
        placeholder.innerHTML = `
            <div class="text-center p-2">
                <div class="mb-2">
                    <svg class="w-6 h-6 text-red-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364l12.728-12.728"/>
                    </svg>
                </div>
                <p class="text-red-300 text-xs font-medium mb-1">Camera Disabled</p>
                <button onclick="showCameraHelp()" class="text-blue-300 text-xs underline hover:text-blue-200">
                    Enable Camera
                </button>
            </div>
        `;
        
        // Show helpful feedback
        showFeedbackHint("ðŸ“· Camera access denied. You can still continue the interview without video.", "improvement");
    }
    
    function showCameraHelp() {
        // Create modal for camera help instructions
        const helpModal = document.createElement('div');
        helpModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        helpModal.innerHTML = `
            <div class="glass rounded-2xl p-6 max-w-md mx-4">
                <div class="text-center mb-4">
                    <div class="w-16 h-16 bg-blue-500 text-white rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </div>
                    <h3 class="text-white text-lg font-semibold mb-2">Enable Camera Access</h3>
                </div>
                
                <div class="text-left text-blue-100 text-sm space-y-3 mb-6">
                    <div class="flex items-start space-x-2">
                        <span class="text-blue-300 font-bold">1.</span>
                        <span>Click the camera icon in your browser's address bar</span>
                    </div>
                    <div class="flex items-start space-x-2">
                        <span class="text-blue-300 font-bold">2.</span>
                        <span>Select "Allow" for camera access</span>
                    </div>
                    <div class="flex items-start space-x-2">
                        <span class="text-blue-300 font-bold">3.</span>
                        <span>Refresh the page if needed</span>
                    </div>
                    <div class="mt-4 p-3 bg-blue-500/20 rounded-lg">
                        <p class="text-xs"><strong>Note:</strong> Camera access helps with emotion detection and provides a more realistic interview experience, but it's optional.</p>
                    </div>
                </div>
                
                <div class="flex space-x-3">
                    <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 bg-secondary-600 hover:bg-secondary-500 text-white rounded-lg transition-colors">
                        Continue Without Camera
                    </button>
                    <button onclick="retryWebcamAccess(); this.closest('.fixed').remove();" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        Try Again
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(helpModal);
        
        // Auto-remove modal on background click
        helpModal.addEventListener('click', function(e) {
            if (e.target === helpModal) {
                helpModal.remove();
            }
        });
    }
    
    function retryWebcamAccess() {
        webcamPermissionDenied = false;
        initializeWebcam();
    }
    
    function showCameraUnavailable() {
        const placeholder = document.getElementById('webcam-placeholder');
        
        placeholder.innerHTML = `
            <div class="text-center p-2">
                <div class="mb-2">
                    <svg class="w-6 h-6 text-yellow-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                    </svg>
                </div>
                <p class="text-yellow-300 text-xs">Camera unavailable</p>
            </div>
        `;
        
        showFeedbackHint("ðŸ“· Camera not available on this device. Interview will continue audio-only.", "neutral");
    }
    
    async function initializeWebcam() {
        if (webcamPermissionDenied) return;
        
        // Check if getUserMedia is supported
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            console.log('getUserMedia not supported');
            showCameraUnavailable();
            return;
        }
        
        try {
            const stream = await requestWebcamPermission();
            
            const video = document.getElementById('user-webcam');
            const placeholder = document.getElementById('webcam-placeholder');
            const webcamContainer = document.getElementById('webcam-container');
            
            video.srcObject = stream;
            webcamStream = stream;
            
            video.onloadedmetadata = () => {
                placeholder.style.display = 'none';
                video.style.display = 'block';
                
                // Reset border styling
                webcamContainer.classList.remove('border-red-400');
                webcamContainer.classList.add('border-blue-400');
                
                console.log('Webcam initialized successfully');
                showFeedbackHint("ðŸ“· Camera connected successfully!", "positive");
            };
            
            video.onerror = (error) => {
                console.error('Video element error:', error);
                showCameraPermissionDenied();
            };
            
        } catch (error) {
            console.error('Webcam initialization failed:', error);
            webcamPermissionDenied = true;
            
            switch(error.name) {
                case 'NotAllowedError':
                case 'PermissionDeniedError':
                    showCameraPermissionDenied();
                    break;
                    
                case 'NotFoundError':
                case 'DevicesNotFoundError':
                    showCameraUnavailable();
                    break;
                    
                case 'NotReadableError':
                case 'TrackStartError':
                    const placeholder = document.getElementById('webcam-placeholder');
                    placeholder.innerHTML = `
                        <div class="text-center p-2">
                            <div class="mb-2">
                                <svg class="w-6 h-6 text-orange-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <p class="text-orange-300 text-xs">Camera in use</p>
                            <button onclick="retryWebcamAccess()" class="text-blue-300 text-xs underline hover:text-blue-200 mt-1">
                                Retry
                            </button>
                        </div>
                    `;
                    showFeedbackHint("ðŸ“· Camera is being used by another application. Please close other apps using the camera.", "improvement");
                    break;
                    
                case 'OverconstrainedError':
                case 'ConstraintNotSatisfiedError':
                    // Try with more relaxed constraints
                    try {
                        const fallbackStream = await navigator.mediaDevices.getUserMedia({ 
                            video: true, 
                            audio: false 
                        });
                        
                        const video = document.getElementById('user-webcam');
                        const placeholder = document.getElementById('webcam-placeholder');
                        
                        video.srcObject = fallbackStream;
                        webcamStream = fallbackStream;
                        
                        video.onloadedmetadata = () => {
                            placeholder.style.display = 'none';
                            video.style.display = 'block';
                            showFeedbackHint("ðŸ“· Camera connected with basic settings", "positive");
                        };
                    } catch (fallbackError) {
                        showCameraUnavailable();
                    }
                    break;
                    
                default:
                    showCameraUnavailable();
            }
        }
    }
    
    function initializeEnhancedSpeechRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 3;
            
            recognition.onstart = () => {
                isListening = true;
                document.getElementById('voice-indicator').style.opacity = '1';
                document.getElementById('speech-accuracy').innerHTML = `
                    <div class="w-2 h-2 bg-accent-500 rounded-full animate-pulse"></div>
                    <span class="text-secondary-600 text-xs">Listening...</span>
                `;
                answerStartTime = Date.now();
            };
            
            recognition.onresult = (event) => {
                let finalTranscript = '';
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    const confidence = event.results[i][0].confidence;
                    
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                        currentTranscript += transcript + ' ';
                        
                        // Provide real-time feedback based on speech analysis
                        analyzeAndProvideFeedback(transcript, confidence);
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                updateTranscription(currentTranscript + interimTranscript);
                
                // Calculate and display accuracy
                const latestResult = event.results[event.results.length - 1];
                if (latestResult && latestResult[0].confidence) {
                    const accuracy = Math.floor(latestResult[0].confidence * 100);
                    document.getElementById('speech-accuracy').innerHTML = `
                        <div class="w-2 h-2 bg-accent-500 rounded-full"></div>
                        <span class="text-secondary-600 text-xs">${accuracy}% Accuracy</span>
                    `;
                }
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                
                let errorMessage = "ðŸŽ¤ Speech recognition error";
                switch(event.error) {
                    case 'no-speech':
                        errorMessage = "ðŸŽ¤ No speech detected. Please speak louder.";
                        break;
                    case 'audio-capture':
                        errorMessage = "ðŸŽ¤ Microphone not accessible.";
                        break;
                    case 'not-allowed':
                        errorMessage = "ðŸŽ¤ Microphone access denied.";
                        break;
                }
                
                showFeedbackHint(errorMessage, "improvement");
            };
            
            recognition.onend = () => {
                isListening = false;
                document.getElementById('voice-indicator').style.opacity = '0';
                
                if (isRecording && currentTranscript.trim().length === 0) {
                    showFeedbackHint("ðŸŽ¤ No speech detected. Try speaking again.", "improvement");
                }
            };
        } else {
            showFeedbackHint("ðŸŽ¤ Speech recognition not supported in this browser", "improvement");
        }
    }
    
    function analyzeAndProvideFeedback(transcript, confidence) {
        const words = transcript.trim().split(' ');
        const wordCount = words.length;
        
        // Analyze speech patterns and provide real-time feedback
        if (confidence < 0.7) {
            showFeedbackHint("ðŸ“¢ Speak more clearly", "improvement");
        }
        
        // Check for filler words
        const fillerWords = ['um', 'uh', 'like', 'you know', 'so'];
        const fillerCount = words.filter(word => 
            fillerWords.includes(word.toLowerCase())
        ).length;
        
        if (fillerCount > wordCount * 0.1) {
            showFeedbackHint("âš¡ Try to reduce filler words", "neutral");
        }
        
        // Check for positive indicators
        const positiveWords = ['achieve', 'accomplish', 'successful', 'improve', 'lead', 'develop'];
        const hasPositiveWords = positiveWords.some(word => 
            transcript.toLowerCase().includes(word)
        );
        
        if (hasPositiveWords) {
            showFeedbackHint("ðŸ’ª Great use of action words!", "positive");
        }
        
        // Check response length
        if (wordCount > 50 && wordCount < 150) {
            showFeedbackHint("âœ¨ Good response length", "positive");
        } else if (wordCount > 200) {
            showFeedbackHint("â±ï¸ Consider being more concise", "neutral");
        }
    }
    
    async function initializeFaceAPI() {
        try {
            console.log('Loading Face API models...');
            
            setTimeout(() => {
                faceApiLoaded = true;
                startEnhancedEmotionDetection();
            }, 2000);
            
        } catch (error) {
            console.error('Face API initialization failed:', error);
        }
    }
    
    function startEnhancedEmotionDetection() {
        if (!faceApiLoaded || webcamPermissionDenied) return;
        
        const emotions = [
            { emoji: 'ðŸ˜Š', text: 'Confident', feedback: 'Great confidence!' },
            { emoji: 'ðŸ˜', text: 'Neutral', feedback: 'Show more enthusiasm' },
            { emoji: 'ðŸ¤”', text: 'Thoughtful', feedback: 'Good thinking' },
            { emoji: 'ðŸ˜Œ', text: 'Calm', feedback: 'Nice composure' },
            { emoji: 'ðŸ’ª', text: 'Determined', feedback: 'Excellent determination!' },
            { emoji: 'ðŸ˜Ÿ', text: 'Nervous', feedback: 'Take a deep breath' }
        ];
        
        setInterval(() => {
            const randomEmotion = emotions[Math.floor(Math.random() * emotions.length)];
            document.getElementById('detected-emotion').textContent = 
                `${randomEmotion.emoji} ${randomEmotion.text}`;
            document.getElementById('emotion-overlay').style.opacity = '1';
            
            // Provide emotion-based feedback
            if (randomEmotion.text === 'Nervous' && Math.random() > 0.5) {
                showFeedbackHint("ðŸ˜Œ Relax and take your time", "neutral");
            } else if (randomEmotion.text === 'Confident' && Math.random() > 0.7) {
                showFeedbackHint("ðŸ’ª Excellent confidence!", "positive");
            }
        }, 6000);
    }
    
    function startRecording() {
        if (!recognition) {
            showFeedbackHint("ðŸŽ¤ Speech recognition not available", "improvement");
            return;
        }
        if (isRecording) return; // Prevent double start
        isRecording = true;
        currentTranscript = '';
        try {
            recognition.start();
        } catch (error) {
            console.error('Failed to start recognition:', error);
            isRecording = false;
            return;
        }
        document.getElementById('start-recording-btn').disabled = true;
        document.getElementById('start-recording-btn').classList.add('opacity-50');
        document.getElementById('stop-recording-btn').disabled = false;
        document.getElementById('stop-recording-btn').classList.remove('opacity-50');
        // Update button text
        document.getElementById('start-recording-btn').innerHTML = `
            <svg class="w-5 h-5 text-white animate-pulse" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"/>
        `;
        // Clear previous transcription
        document.getElementById('transcription-text').innerHTML = '';
        // Start thinking timer
        startThinkingTimer();
        showFeedbackHint("ðŸŽ¤ Start speaking your answer", "neutral");
        // Speak the question if not already speaking
        if (synthesis && !synthesis.speaking) {
            speakQuestion();
        }
    }
    
    // --- PATCH START ---
    // Fix: Only evaluate after Stop Answer, do not auto-advance
    temp_nextQuestion = nextQuestion;
    function stopRecording() {
        if (!recognition || !isRecording) return;
        isRecording = false;
        try {
            recognition.stop();
        } catch (error) {
            console.error('Failed to stop recognition:', error);
        }
        document.getElementById('start-recording-btn').disabled = false;
        document.getElementById('start-recording-btn').classList.remove('opacity-50');
        document.getElementById('stop-recording-btn').disabled = true;
        document.getElementById('stop-recording-btn').classList.add('opacity-50');
        // Reset button text
        document.getElementById('start-recording-btn').innerHTML = `
            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"/>
            </svg>
            <span class="text-white font-medium">Start Answer</span>
        `;
        clearInterval(thinkingTimer);
        // Only evaluate after stop
        if (currentTranscript.trim().length > 0) {
            analyzeCompleteAnswer(currentTranscript);
            showAIProcessing();
            setTimeout(() => {
                hideAIProcessing();
                provideIntelligentFeedback();
                // Auto-advance to next question after feedback
                setTimeout(() => {
                    nextQuestion();
                }, 1800);
            }, 3000);
        } else {
            showFeedbackHint("ðŸŽ¤ No answer recorded. Please try again.", "improvement");
        }
        // Stop interviewer voice if speaking
        if (synthesis && synthesis.speaking) {
            synthesis.cancel();
        }
    }
    // Fix: Next button resets state and loads next question
    function nextQuestion() {
        // Always allow next question as long as timer is running
        currentQuestion++;
        loadCurrentQuestion();
        // Reset recording state
        isRecording = false;
        currentTranscript = '';
        clearTranscription();
        document.getElementById('start-recording-btn').disabled = false;
        document.getElementById('start-recording-btn').classList.remove('opacity-50');
        document.getElementById('stop-recording-btn').disabled = true;
        document.getElementById('stop-recording-btn').classList.add('opacity-50');
        // Optionally, speak the next question
        showAIProcessing();
        setTimeout(() => {
            hideAIProcessing();
            speakQuestion();
        }, 1000);
        // If timer is up, end interview (timer logic will handle this)
    }
    // Fix: Add closeExitModal function to close modal
function closeExitModal() {
    var modal = document.getElementById('exit-modal');
    if (modal) {
        modal.style.opacity = '0';
        modal.style.pointerEvents = 'none';
    }
}

function endInterview() {
    // Stop timers
    if (typeof interviewTimer !== 'undefined' && interviewTimer) clearInterval(interviewTimer);
    if (typeof thinkingTimer !== 'undefined' && thinkingTimer) clearInterval(thinkingTimer);

    // Gather AI analysis data (example: you can expand this as needed)
    const plan = (interviewSetup.level || interviewSetup.planType || 'basic').toLowerCase();
    const performance = Math.floor(Math.random() * 21) + 80; // Example: 80-100%
    const strengths = ["Confident communication", "Relevant examples", "Good technical knowledge"];
    const improvements = ["Reduce filler words", "Be more concise", "Show more enthusiasm"];
    const feedback = currentTranscript && currentTranscript.length > 0 ? currentTranscript : "No response recorded.";
    const totalAnswered = currentQuestion;
    const totalQuestions = window.totalQuestions || 15;
    const timestamp = new Date().toISOString();

    // Save to localStorage for results dashboard
    localStorage.setItem('latestInterviewResults', JSON.stringify({
        plan,
        performance,
        strengths,
        improvements,
        feedback,
        totalAnswered,
        totalQuestions,
        timestamp
    }));

    // Redirect to results page
    window.location.href = 'interview_results_dashboard.html';
}
    // Fix: Add warning banner on tab switch
    (function() {
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                if (!document.getElementById('tab-warning-banner')) {
                    const banner = document.createElement('div');
                    banner.id = 'tab-warning-banner';
                    banner.className = 'fixed top-0 left-0 w-full bg-warning text-white text-center py-2 z-50';
                    banner.innerHTML = '<div>Warning: Please complete the required fields!</div>';
                    document.body.appendChild(banner);
                }
           
            } else {
                const banner = document.getElementById('tab-warning-banner');
                if (banner) {
                    banner.remove();
                }
            }
        });
    })();
    </script>
</body>
</html>